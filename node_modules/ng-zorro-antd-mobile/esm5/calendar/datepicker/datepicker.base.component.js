/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { DateModels } from '../date/DataTypes';
import { formatDate } from '../util';
import defaultLocale from '../locale/zh_CN';
/**
 * @record
 */
export function DatepickerStateType() { }
if (false) {
    /** @type {?} */
    DatepickerStateType.prototype.months;
}
var CalendarDatePickerBaseComponent = /** @class */ (function () {
    function CalendarDatePickerBaseComponent() {
        var _this = this;
        this.props = (/** @type {?} */ ({
            prefixCls: 'rmc-calendar',
            infinite: false,
            infiniteOpt: false,
            defaultDate: new Date(),
            initalMonths: 6,
            locale: defaultLocale
        }));
        this.state = {
            months: []
        };
        this.visibleMonth = [];
        this.getDateWithoutTime = (/**
         * @param {?=} date
         * @return {?}
         */
        function (date) {
            if (!date)
                return 0;
            return +new Date(date.getFullYear(), date.getMonth(), date.getDate());
        });
        this.genWeekData = (/**
         * @param {?} firstDate
         * @return {?}
         */
        function (firstDate) {
            /** @type {?} */
            var minDateTime = _this.getDateWithoutTime(_this.props.minDate);
            /** @type {?} */
            var maxDateTime = _this.getDateWithoutTime(_this.props.maxDate) || Number.POSITIVE_INFINITY;
            /** @type {?} */
            var weeks = [];
            /** @type {?} */
            var nextMonth = _this.getMonthDate(firstDate, 1).firstDate;
            /** @type {?} */
            var currentDay = firstDate;
            /** @type {?} */
            var currentWeek = [];
            weeks.push(currentWeek);
            /** @type {?} */
            var startWeekday = currentDay.getDay();
            if (startWeekday > 0) {
                for (var i = 0; i < startWeekday; i++) {
                    currentWeek.push((/** @type {?} */ ({})));
                }
            }
            while (currentDay < nextMonth) {
                if (currentWeek.length === 7) {
                    currentWeek = [];
                    weeks.push(currentWeek);
                }
                /** @type {?} */
                var dayOfMonth = currentDay.getDate();
                /** @type {?} */
                var tick = +currentDay;
                currentWeek.push({
                    tick: tick,
                    dayOfMonth: dayOfMonth,
                    selected: DateModels.SelectType.None,
                    isFirstOfMonth: dayOfMonth === 1,
                    isLastOfMonth: false,
                    outOfDate: tick < minDateTime || tick > maxDateTime
                });
                currentDay = new Date(currentDay.getTime() + 3600 * 24 * 1000);
            }
            currentWeek[currentWeek.length - 1].isLastOfMonth = true;
            return weeks;
        });
        this.selectDateRange = (/**
         * @param {?} startDate
         * @param {?=} endDate
         * @param {?=} clear
         * @return {?}
         */
        function (startDate, endDate, clear) {
            if (clear === void 0) { clear = false; }
            var _a = _this.props, getDateExtra = _a.getDateExtra, type = _a.type, onSelectHasDisableDate = _a.onSelectHasDisableDate;
            if (type === 'one') {
                endDate = undefined;
            }
            /** @type {?} */
            var time1 = _this.getDateWithoutTime(startDate);
            /** @type {?} */
            var time2 = _this.getDateWithoutTime(endDate);
            /** @type {?} */
            var startDateTick = !time2 || time1 < time2 ? time1 : time2;
            /** @type {?} */
            var endDateTick = time2 && time1 > time2 ? time1 : time2;
            /** @type {?} */
            var startMonthDate = _this.getMonthDate(new Date(startDateTick)).firstDate;
            /** @type {?} */
            var endMonthDate = endDateTick ? new Date(endDateTick) : _this.getMonthDate(new Date(startDateTick)).lastDate;
            /** @type {?} */
            var unuseable = [];
            /** @type {?} */
            var needUpdate = false;
            _this.state.months
                .filter((/**
             * @param {?} m
             * @return {?}
             */
            function (m) {
                return m.firstDate >= startMonthDate && m.firstDate <= endMonthDate;
            }))
                .forEach((/**
             * @param {?} m
             * @return {?}
             */
            function (m) {
                m.weeks.forEach((/**
                 * @param {?} w
                 * @return {?}
                 */
                function (w) {
                    return w
                        .filter((/**
                     * @param {?} d
                     * @return {?}
                     */
                    function (d) {
                        if (!endDateTick) {
                            return d.tick && _this.inDate(startDateTick, d.tick);
                        }
                        else {
                            return d.tick && d.tick >= startDateTick && d.tick <= endDateTick;
                        }
                    }))
                        .forEach((/**
                     * @param {?} d
                     * @return {?}
                     */
                    function (d) {
                        /** @type {?} */
                        var oldValue = d.selected;
                        if (clear) {
                            d.selected = DateModels.SelectType.None;
                        }
                        else {
                            /** @type {?} */
                            var info = (getDateExtra && getDateExtra(new Date(d.tick))) || {};
                            if (d.outOfDate || info.disable) {
                                unuseable.push(d.tick);
                            }
                            if (_this.inDate(startDateTick, d.tick)) {
                                if (type === 'one') {
                                    d.selected = DateModels.SelectType.Single;
                                }
                                else if (!endDateTick) {
                                    d.selected = DateModels.SelectType.Only;
                                }
                                else if (startDateTick !== endDateTick) {
                                    d.selected = DateModels.SelectType.Start;
                                }
                                else {
                                    d.selected = DateModels.SelectType.All;
                                }
                            }
                            else if (_this.inDate(endDateTick, d.tick)) {
                                d.selected = DateModels.SelectType.End;
                            }
                            else {
                                d.selected = DateModels.SelectType.Middle;
                            }
                        }
                        needUpdate = needUpdate || d.selected !== oldValue;
                    }));
                }));
                if (needUpdate && m.componentRef) {
                    m.componentRef.updateWeeks();
                }
            }));
            if (unuseable.length > 0) {
                if (onSelectHasDisableDate) {
                    onSelectHasDisableDate(unuseable.map((/**
                     * @param {?} tick
                     * @return {?}
                     */
                    function (tick) { return new Date(tick); })));
                }
                else {
                    console.warn('Unusable date. You can handle by onSelectHasDisableDate.', unuseable);
                }
            }
        });
        this.computeVisible = (/**
         * @param {?} clientHeight
         * @param {?} scrollTop
         * @return {?}
         */
        function (clientHeight, scrollTop) {
            /** @type {?} */
            var needUpdate = false;
            /** @type {?} */
            var MAX_VIEW_PORT = clientHeight * 2;
            /** @type {?} */
            var MIN_VIEW_PORT = clientHeight;
            // 大缓冲区外过滤规则
            /** @type {?} */
            var filterFunc = (/**
             * @param {?} vm
             * @return {?}
             */
            function (vm) {
                return vm.y &&
                    vm.height &&
                    (vm.y + vm.height > scrollTop - MAX_VIEW_PORT && vm.y < scrollTop + clientHeight + MAX_VIEW_PORT);
            });
            if (_this.props.infiniteOpt && _this.visibleMonth.length > 12) {
                _this.visibleMonth = _this.visibleMonth.filter(filterFunc).sort((/**
                 * @param {?} a
                 * @param {?} b
                 * @return {?}
                 */
                function (a, b) { return +a.firstDate - +b.firstDate; }));
            }
            // 当小缓冲区不满时填充
            if (_this.visibleMonth.length > 0) {
                /** @type {?} */
                var last = _this.visibleMonth[_this.visibleMonth.length - 1];
                if (last.y !== undefined && last.height && last.y + last.height < scrollTop + clientHeight + MIN_VIEW_PORT) {
                    /** @type {?} */
                    var lastIndex = _this.state.months.indexOf(last);
                    for (var i = 1; i <= 2; i++) {
                        /** @type {?} */
                        var index = lastIndex + i;
                        if (index < _this.state.months.length && _this.visibleMonth.indexOf(_this.state.months[index]) < 0) {
                            _this.visibleMonth.push(_this.state.months[index]);
                        }
                        else {
                            _this.canLoadNext() && _this.genMonthData(undefined, 1);
                        }
                    }
                    needUpdate = true;
                }
                /** @type {?} */
                var first = _this.visibleMonth[0];
                if (first.y !== undefined && first.height && first.y > scrollTop - MIN_VIEW_PORT) {
                    /** @type {?} */
                    var firstIndex = _this.state.months.indexOf(first);
                    for (var i = 1; i <= 2; i++) {
                        /** @type {?} */
                        var index = firstIndex - i;
                        if (index >= 0 && _this.visibleMonth.indexOf(_this.state.months[index]) < 0) {
                            _this.visibleMonth.unshift(_this.state.months[index]);
                            needUpdate = true;
                        }
                    }
                }
            }
            else if (_this.state.months.length > 0) {
                _this.visibleMonth = _this.state.months.filter(filterFunc);
                needUpdate = true;
            }
            return needUpdate;
        });
        this.createOnScroll = (/**
         * @return {?}
         */
        function () {
            // let timer: any;
            /** @type {?} */
            var clientHeight = 0;
            /** @type {?} */
            var scrollTop = 0;
            return (/**
             * @param {?} data
             * @return {?}
             */
            function (data) {
                var client = data.client, top = data.top;
                clientHeight = client;
                scrollTop = top;
                _this.computeVisible(clientHeight, scrollTop);
                // 以上方法目前无问题，如果后续有性能问题，改用如下方法，但以下方法会导致刷新稍微延迟现象
                // if (timer) {
                //   return;
                // }
                //
                // timer = setTimeout(() => {
                //   timer = undefined;
                //
                //   if (this.computeVisible(clientHeight, scrollTop)) {
                //     console.log('update dom');
                //   }
                // }, 50);
            });
        });
        this.baseOnCellClick = (/**
         * @param {?} day
         * @return {?}
         */
        function (day) {
            if (!day.tick)
                return;
            _this.props.onCellClick && _this.props.onCellClick(new Date(day.tick));
        });
    }
    /**
     * @return {?}
     */
    CalendarDatePickerBaseComponent.prototype.init = /**
     * @return {?}
     */
    function () {
        var _a = this.props, _b = _a.initalMonths, initalMonths = _b === void 0 ? 6 : _b, defaultDate = _a.defaultDate;
        for (var i = 0; i < initalMonths; i++) {
            this.canLoadNext() && this.genMonthData(defaultDate, i);
        }
        this.visibleMonth = tslib_1.__spread(this.state.months);
    };
    /**
     * @param {?} oldValue
     * @param {?} newValue
     * @return {?}
     */
    CalendarDatePickerBaseComponent.prototype.receiveProps = /**
     * @param {?} oldValue
     * @param {?} newValue
     * @return {?}
     */
    function (oldValue, newValue) {
        if (oldValue && newValue) {
            if (oldValue.startDate !== newValue.startDate || oldValue.endDate !== newValue.endDate) {
                if (oldValue.startDate) {
                    this.selectDateRange(oldValue.startDate, oldValue.endDate, true);
                }
                if (newValue.startDate) {
                    this.selectDateRange(newValue.startDate, newValue.endDate);
                }
            }
        }
    };
    /**
     * @param {?=} date
     * @param {?=} addMonth
     * @return {?}
     */
    CalendarDatePickerBaseComponent.prototype.getMonthDate = /**
     * @param {?=} date
     * @param {?=} addMonth
     * @return {?}
     */
    function (date, addMonth) {
        if (date === void 0) { date = new Date(); }
        if (addMonth === void 0) { addMonth = 0; }
        /** @type {?} */
        var y = date.getFullYear();
        /** @type {?} */
        var m = date.getMonth();
        return {
            firstDate: new Date(y, m + addMonth, 1),
            lastDate: new Date(y, m + 1 + addMonth, 0)
        };
    };
    /**
     * @return {?}
     */
    CalendarDatePickerBaseComponent.prototype.canLoadPrev = /**
     * @return {?}
     */
    function () {
        var minDate = this.props.minDate;
        return (!minDate ||
            this.state.months.length <= 0 ||
            +this.getMonthDate(minDate).firstDate < +this.state.months[0].firstDate);
    };
    /**
     * @return {?}
     */
    CalendarDatePickerBaseComponent.prototype.canLoadNext = /**
     * @return {?}
     */
    function () {
        var maxDate = this.props.maxDate;
        return (!maxDate ||
            this.state.months.length <= 0 ||
            +this.getMonthDate(maxDate).firstDate > +this.state.months[this.state.months.length - 1].firstDate);
    };
    /**
     * @param {?=} date
     * @param {?=} addMonth
     * @return {?}
     */
    CalendarDatePickerBaseComponent.prototype.genMonthData = /**
     * @param {?=} date
     * @param {?=} addMonth
     * @return {?}
     */
    function (date, addMonth) {
        if (addMonth === void 0) { addMonth = 0; }
        if (!date) {
            date = addMonth >= 0 ? this.state.months[this.state.months.length - 1].firstDate : this.state.months[0].firstDate;
        }
        if (!date) {
            date = new Date();
        }
        var locale = this.props.locale;
        var _a = this.getMonthDate(date, addMonth), firstDate = _a.firstDate, lastDate = _a.lastDate;
        /** @type {?} */
        var weeks = this.genWeekData(firstDate);
        /** @type {?} */
        var title = formatDate(firstDate, locale ? locale.monthTitle : 'yyyy/MM', this.props.locale);
        /** @type {?} */
        var data = (/** @type {?} */ ({
            title: title,
            firstDate: firstDate,
            lastDate: lastDate,
            weeks: weeks
        }));
        data.component = this.genMonthComponent(data);
        if (addMonth >= 0) {
            this.state.months.push(data);
        }
        else {
            this.state.months.unshift(data);
        }
        var _b = this.props, startDate = _b.startDate, endDate = _b.endDate;
        if (startDate) {
            this.selectDateRange(startDate, endDate);
        }
        return data;
    };
    /**
     * @param {?} date
     * @param {?} tick
     * @return {?}
     */
    CalendarDatePickerBaseComponent.prototype.inDate = /**
     * @param {?} date
     * @param {?} tick
     * @return {?}
     */
    function (date, tick) {
        return date <= tick && tick < date + 24 * 3600000;
    };
    return CalendarDatePickerBaseComponent;
}());
export { CalendarDatePickerBaseComponent };
if (false) {
    /** @type {?} */
    CalendarDatePickerBaseComponent.prototype.props;
    /** @type {?} */
    CalendarDatePickerBaseComponent.prototype.state;
    /** @type {?} */
    CalendarDatePickerBaseComponent.prototype.visibleMonth;
    /** @type {?} */
    CalendarDatePickerBaseComponent.prototype.genMonthComponent;
    /** @type {?} */
    CalendarDatePickerBaseComponent.prototype.getDateWithoutTime;
    /** @type {?} */
    CalendarDatePickerBaseComponent.prototype.genWeekData;
    /** @type {?} */
    CalendarDatePickerBaseComponent.prototype.selectDateRange;
    /** @type {?} */
    CalendarDatePickerBaseComponent.prototype.computeVisible;
    /** @type {?} */
    CalendarDatePickerBaseComponent.prototype.createOnScroll;
    /** @type {?} */
    CalendarDatePickerBaseComponent.prototype.baseOnCellClick;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZXBpY2tlci5iYXNlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25nLXpvcnJvLWFudGQtbW9iaWxlLyIsInNvdXJjZXMiOlsiY2FsZW5kYXIvZGF0ZXBpY2tlci9kYXRlcGlja2VyLmJhc2UuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRS9DLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDckMsT0FBTyxhQUFhLE1BQU0saUJBQWlCLENBQUM7Ozs7QUFFNUMseUNBRUM7OztJQURDLHFDQUErQjs7QUFHakM7SUFpQkU7UUFBQSxpQkFBZ0I7UUFoQmhCLFVBQUssR0FBRyxtQkFBQTtZQUNOLFNBQVMsRUFBRSxjQUFjO1lBQ3pCLFFBQVEsRUFBRSxLQUFLO1lBQ2YsV0FBVyxFQUFFLEtBQUs7WUFDbEIsV0FBVyxFQUFFLElBQUksSUFBSSxFQUFFO1lBQ3ZCLFlBQVksRUFBRSxDQUFDO1lBQ2YsTUFBTSxFQUFFLGFBQWE7U0FDdEIsRUFBdUIsQ0FBQztRQUV6QixVQUFLLEdBQVE7WUFDWCxNQUFNLEVBQUUsRUFBRTtTQUNYLENBQUM7UUFFRixpQkFBWSxHQUEyQixFQUFFLENBQUM7UUFxRDFDLHVCQUFrQjs7OztRQUFHLFVBQUMsSUFBVztZQUMvQixJQUFJLENBQUMsSUFBSTtnQkFBRSxPQUFPLENBQUMsQ0FBQztZQUNwQixPQUFPLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUN4RSxDQUFDLEVBQUM7UUFFRixnQkFBVzs7OztRQUFHLFVBQUMsU0FBZTs7Z0JBQ3RCLFdBQVcsR0FBRyxLQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUM7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QUksQ0FBQyxDQUFDO1FBQzlDLElBQUksUUFBUSxJQUFJLENBQUMsRUFBRTtZQUNqQixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDOUI7YUFBTTtZQUNMLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNqQztRQUNLLElBQUEsZUFBbUMsRUFBakMsd0JBQVMsRUFBRSxvQkFBc0I7UUFDekMsSUFBSSxTQUFTLEVBQUU7WUFDYixJQUFJLENBQUMsZUFBZSxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQztTQUMxQztRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQzs7Ozs7O0lBRUQsZ0RBQU07Ozs7O0lBQU4sVUFBTyxJQUFZLEVBQUUsSUFBWTtRQUMvQixPQUFPLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxHQUFHLElBQUksR0FBRyxFQUFFLEdBQUcsT0FBTyxDQUFDO0lBQ3BELENBQUM7SUEySkgsc0NBQUM7QUFBRCxDQUFDLEFBeFNELElBd1NDOzs7O0lBdlNDLGdEQU95Qjs7SUFFekIsZ0RBRUU7O0lBRUYsdURBQTBDOztJQUMxQyw0REFBZ0M7O0lBb0RoQyw2REFHRTs7SUFFRixzREFtQ0U7O0lBb0NGLDBEQW9FRTs7SUFFRix5REFnREU7O0lBRUYseURBMEJFOztJQUVGLDBEQUdFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGF0ZU1vZGVscyB9IGZyb20gJy4uL2RhdGUvRGF0YVR5cGVzJztcbmltcG9ydCB7IERhdGVwaWNrZXJQcm9wc1R5cGUgfSBmcm9tICcuL2RhdGVwaWNrZXIucHJvcHMuY29tcG9uZW50JztcbmltcG9ydCB7IGZvcm1hdERhdGUgfSBmcm9tICcuLi91dGlsJztcbmltcG9ydCBkZWZhdWx0TG9jYWxlIGZyb20gJy4uL2xvY2FsZS96aF9DTic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGF0ZXBpY2tlclN0YXRlVHlwZSB7XG4gIG1vbnRoczogRGF0ZU1vZGVscy5Nb250aERhdGFbXTtcbn1cblxuZXhwb3J0IGNsYXNzIENhbGVuZGFyRGF0ZVBpY2tlckJhc2VDb21wb25lbnQge1xuICBwcm9wcyA9IHtcbiAgICBwcmVmaXhDbHM6ICdybWMtY2FsZW5kYXInLFxuICAgIGluZmluaXRlOiBmYWxzZSxcbiAgICBpbmZpbml0ZU9wdDogZmFsc2UsXG4gICAgZGVmYXVsdERhdGU6IG5ldyBEYXRlKCksXG4gICAgaW5pdGFsTW9udGhzOiA2LFxuICAgIGxvY2FsZTogZGVmYXVsdExvY2FsZVxuICB9IGFzIERhdGVwaWNrZXJQcm9wc1R5cGU7XG5cbiAgc3RhdGU6IGFueSA9IHtcbiAgICBtb250aHM6IFtdXG4gIH07XG5cbiAgdmlzaWJsZU1vbnRoOiBEYXRlTW9kZWxzLk1vbnRoRGF0YVtdID0gW107XG4gIGdlbk1vbnRoQ29tcG9uZW50OiAoZGF0YSkgPT4ge307XG5cbiAgY29uc3RydWN0b3IoKSB7fVxuXG4gIGluaXQoKSB7XG4gICAgY29uc3QgeyBpbml0YWxNb250aHMgPSA2LCBkZWZhdWx0RGF0ZSB9ID0gdGhpcy5wcm9wcztcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluaXRhbE1vbnRoczsgaSsrKSB7XG4gICAgICB0aGlzLmNhbkxvYWROZXh0KCkgJiYgdGhpcy5nZW5Nb250aERhdGEoZGVmYXVsdERhdGUsIGkpO1xuICAgIH1cbiAgICB0aGlzLnZpc2libGVNb250aCA9IFsuLi50aGlzLnN0YXRlLm1vbnRoc107XG4gIH1cblxuICByZWNlaXZlUHJvcHMob2xkVmFsdWU6IERhdGVwaWNrZXJQcm9wc1R5cGUsIG5ld1ZhbHVlOiBEYXRlcGlja2VyUHJvcHNUeXBlKSB7XG4gICAgaWYgKG9sZFZhbHVlICYmIG5ld1ZhbHVlKSB7XG4gICAgICBpZiAob2xkVmFsdWUuc3RhcnREYXRlICE9PSBuZXdWYWx1ZS5zdGFydERhdGUgfHwgb2xkVmFsdWUuZW5kRGF0ZSAhPT0gbmV3VmFsdWUuZW5kRGF0ZSkge1xuICAgICAgICBpZiAob2xkVmFsdWUuc3RhcnREYXRlKSB7XG4gICAgICAgICAgdGhpcy5zZWxlY3REYXRlUmFuZ2Uob2xkVmFsdWUuc3RhcnREYXRlLCBvbGRWYWx1ZS5lbmREYXRlLCB0cnVlKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobmV3VmFsdWUuc3RhcnREYXRlKSB7XG4gICAgICAgICAgdGhpcy5zZWxlY3REYXRlUmFuZ2UobmV3VmFsdWUuc3RhcnREYXRlLCBuZXdWYWx1ZS5lbmREYXRlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGdldE1vbnRoRGF0ZShkYXRlID0gbmV3IERhdGUoKSwgYWRkTW9udGggPSAwKSB7XG4gICAgY29uc3QgeSA9IGRhdGUuZ2V0RnVsbFllYXIoKSxcbiAgICAgIG0gPSBkYXRlLmdldE1vbnRoKCk7XG4gICAgcmV0dXJuIHtcbiAgICAgIGZpcnN0RGF0ZTogbmV3IERhdGUoeSwgbSArIGFkZE1vbnRoLCAxKSxcbiAgICAgIGxhc3REYXRlOiBuZXcgRGF0ZSh5LCBtICsgMSArIGFkZE1vbnRoLCAwKVxuICAgIH07XG4gIH1cblxuICBjYW5Mb2FkUHJldigpIHtcbiAgICBjb25zdCB7IG1pbkRhdGUgfSA9IHRoaXMucHJvcHM7XG4gICAgcmV0dXJuIChcbiAgICAgICFtaW5EYXRlIHx8XG4gICAgICB0aGlzLnN0YXRlLm1vbnRocy5sZW5ndGggPD0gMCB8fFxuICAgICAgK3RoaXMuZ2V0TW9udGhEYXRlKG1pbkRhdGUpLmZpcnN0RGF0ZSA8ICt0aGlzLnN0YXRlLm1vbnRoc1swXS5maXJzdERhdGVcbiAgICApO1xuICB9XG5cbiAgY2FuTG9hZE5leHQoKSB7XG4gICAgY29uc3QgeyBtYXhEYXRlIH0gPSB0aGlzLnByb3BzO1xuICAgIHJldHVybiAoXG4gICAgICAhbWF4RGF0ZSB8fFxuICAgICAgdGhpcy5zdGF0ZS5tb250aHMubGVuZ3RoIDw9IDAgfHxcbiAgICAgICt0aGlzLmdldE1vbnRoRGF0ZShtYXhEYXRlKS5maXJzdERhdGUgPiArdGhpcy5zdGF0ZS5tb250aHNbdGhpcy5zdGF0ZS5tb250aHMubGVuZ3RoIC0gMV0uZmlyc3REYXRlXG4gICAgKTtcbiAgfVxuXG4gIGdldERhdGVXaXRob3V0VGltZSA9IChkYXRlPzogRGF0ZSkgPT4ge1xuICAgIGlmICghZGF0ZSkgcmV0dXJuIDA7XG4gICAgcmV0dXJuICtuZXcgRGF0ZShkYXRlLmdldEZ1bGxZZWFyKCksIGRhdGUuZ2V0TW9udGgoKSwgZGF0ZS5nZXREYXRlKCkpO1xuICB9O1xuXG4gIGdlbldlZWtEYXRhID0gKGZpcnN0RGF0ZTogRGF0ZSkgPT4ge1xuICAgIGNvbnN0IG1pbkRhdGVUaW1lID0gdGhpcy5nZXREYXRlV2l0aG91dFRpbWUodGhpcy5wcm9wcy5taW5EYXRlKTtcbiAgICBjb25zdCBtYXhEYXRlVGltZSA9IHRoaXMuZ2V0RGF0ZVdpdGhvdXRUaW1lKHRoaXMucHJvcHMubWF4RGF0ZSkgfHwgTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZO1xuXG4gICAgY29uc3Qgd2Vla3M6IERhdGVNb2RlbHMuQ2VsbERhdGFbXVtdID0gW107XG4gICAgY29uc3QgbmV4dE1vbnRoID0gdGhpcy5nZXRNb250aERhdGUoZmlyc3REYXRlLCAxKS5maXJzdERhdGU7XG4gICAgbGV0IGN1cnJlbnREYXkgPSBmaXJzdERhdGU7XG4gICAgbGV0IGN1cnJlbnRXZWVrOiBEYXRlTW9kZWxzLkNlbGxEYXRhW10gPSBbXTtcbiAgICB3ZWVrcy5wdXNoKGN1cnJlbnRXZWVrKTtcblxuICAgIGxldCBzdGFydFdlZWtkYXkgPSBjdXJyZW50RGF5LmdldERheSgpO1xuICAgIGlmIChzdGFydFdlZWtkYXkgPiAwKSB7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0YXJ0V2Vla2RheTsgaSsrKSB7XG4gICAgICAgIGN1cnJlbnRXZWVrLnB1c2goe30gYXMgRGF0ZU1vZGVscy5DZWxsRGF0YSk7XG4gICAgICB9XG4gICAgfVxuICAgIHdoaWxlIChjdXJyZW50RGF5IDwgbmV4dE1vbnRoKSB7XG4gICAgICBpZiAoY3VycmVudFdlZWsubGVuZ3RoID09PSA3KSB7XG4gICAgICAgIGN1cnJlbnRXZWVrID0gW107XG4gICAgICAgIHdlZWtzLnB1c2goY3VycmVudFdlZWspO1xuICAgICAgfVxuICAgICAgY29uc3QgZGF5T2ZNb250aCA9IGN1cnJlbnREYXkuZ2V0RGF0ZSgpO1xuICAgICAgY29uc3QgdGljayA9ICtjdXJyZW50RGF5O1xuICAgICAgY3VycmVudFdlZWsucHVzaCh7XG4gICAgICAgIHRpY2ssXG4gICAgICAgIGRheU9mTW9udGgsXG4gICAgICAgIHNlbGVjdGVkOiBEYXRlTW9kZWxzLlNlbGVjdFR5cGUuTm9uZSxcbiAgICAgICAgaXNGaXJzdE9mTW9udGg6IGRheU9mTW9udGggPT09IDEsXG4gICAgICAgIGlzTGFzdE9mTW9udGg6IGZhbHNlLFxuICAgICAgICBvdXRPZkRhdGU6IHRpY2sgPCBtaW5EYXRlVGltZSB8fCB0aWNrID4gbWF4RGF0ZVRpbWVcbiAgICAgIH0pO1xuICAgICAgY3VycmVudERheSA9IG5ldyBEYXRlKGN1cnJlbnREYXkuZ2V0VGltZSgpICsgMzYwMCAqIDI0ICogMTAwMCk7XG4gICAgfVxuICAgIGN1cnJlbnRXZWVrW2N1cnJlbnRXZWVrLmxlbmd0aCAtIDFdLmlzTGFzdE9mTW9udGggPSB0cnVlO1xuICAgIHJldHVybiB3ZWVrcztcbiAgfTtcblxuICBnZW5Nb250aERhdGEoZGF0ZT86IERhdGUsIGFkZE1vbnRoOiBudW1iZXIgPSAwKSB7XG4gICAgaWYgKCFkYXRlKSB7XG4gICAgICBkYXRlID0gYWRkTW9udGggPj0gMCA/IHRoaXMuc3RhdGUubW9udGhzW3RoaXMuc3RhdGUubW9udGhzLmxlbmd0aCAtIDFdLmZpcnN0RGF0ZSA6IHRoaXMuc3RhdGUubW9udGhzWzBdLmZpcnN0RGF0ZTtcbiAgICB9XG4gICAgaWYgKCFkYXRlKSB7XG4gICAgICBkYXRlID0gbmV3IERhdGUoKTtcbiAgICB9XG4gICAgY29uc3QgeyBsb2NhbGUgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgeyBmaXJzdERhdGUsIGxhc3REYXRlIH0gPSB0aGlzLmdldE1vbnRoRGF0ZShkYXRlLCBhZGRNb250aCk7XG4gICAgY29uc3Qgd2Vla3MgPSB0aGlzLmdlbldlZWtEYXRhKGZpcnN0RGF0ZSk7XG4gICAgY29uc3QgdGl0bGUgPSBmb3JtYXREYXRlKGZpcnN0RGF0ZSwgbG9jYWxlID8gbG9jYWxlLm1vbnRoVGl0bGUgOiAneXl5eS9NTScsIHRoaXMucHJvcHMubG9jYWxlKTtcbiAgICBjb25zdCBkYXRhID0ge1xuICAgICAgdGl0bGUsXG4gICAgICBmaXJzdERhdGUsXG4gICAgICBsYXN0RGF0ZSxcbiAgICAgIHdlZWtzXG4gICAgfSBhcyBEYXRlTW9kZWxzLk1vbnRoRGF0YTtcbiAgICBkYXRhLmNvbXBvbmVudCA9IHRoaXMuZ2VuTW9udGhDb21wb25lbnQoZGF0YSk7XG4gICAgaWYgKGFkZE1vbnRoID49IDApIHtcbiAgICAgIHRoaXMuc3RhdGUubW9udGhzLnB1c2goZGF0YSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc3RhdGUubW9udGhzLnVuc2hpZnQoZGF0YSk7XG4gICAgfVxuICAgIGNvbnN0IHsgc3RhcnREYXRlLCBlbmREYXRlIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChzdGFydERhdGUpIHtcbiAgICAgIHRoaXMuc2VsZWN0RGF0ZVJhbmdlKHN0YXJ0RGF0ZSwgZW5kRGF0ZSk7XG4gICAgfVxuICAgIHJldHVybiBkYXRhO1xuICB9XG5cbiAgaW5EYXRlKGRhdGU6IG51bWJlciwgdGljazogbnVtYmVyKSB7XG4gICAgcmV0dXJuIGRhdGUgPD0gdGljayAmJiB0aWNrIDwgZGF0ZSArIDI0ICogMzYwMDAwMDtcbiAgfVxuXG4gIHNlbGVjdERhdGVSYW5nZSA9IChzdGFydERhdGU6IERhdGUsIGVuZERhdGU/OiBEYXRlLCBjbGVhciA9IGZhbHNlKSA9PiB7XG4gICAgY29uc3QgeyBnZXREYXRlRXh0cmEsIHR5cGUsIG9uU2VsZWN0SGFzRGlzYWJsZURhdGUgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKHR5cGUgPT09ICdvbmUnKSB7XG4gICAgICBlbmREYXRlID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBjb25zdCB0aW1lMSA9IHRoaXMuZ2V0RGF0ZVdpdGhvdXRUaW1lKHN0YXJ0RGF0ZSksXG4gICAgICB0aW1lMiA9IHRoaXMuZ2V0RGF0ZVdpdGhvdXRUaW1lKGVuZERhdGUpO1xuICAgIGNvbnN0IHN0YXJ0RGF0ZVRpY2sgPSAhdGltZTIgfHwgdGltZTEgPCB0aW1lMiA/IHRpbWUxIDogdGltZTI7XG4gICAgY29uc3QgZW5kRGF0ZVRpY2sgPSB0aW1lMiAmJiB0aW1lMSA+IHRpbWUyID8gdGltZTEgOiB0aW1lMjtcblxuICAgIGNvbnN0IHN0YXJ0TW9udGhEYXRlID0gdGhpcy5nZXRNb250aERhdGUobmV3IERhdGUoc3RhcnREYXRlVGljaykpLmZpcnN0RGF0ZTtcbiAgICBjb25zdCBlbmRNb250aERhdGUgPSBlbmREYXRlVGljayA/IG5ldyBEYXRlKGVuZERhdGVUaWNrKSA6IHRoaXMuZ2V0TW9udGhEYXRlKG5ldyBEYXRlKHN0YXJ0RGF0ZVRpY2spKS5sYXN0RGF0ZTtcblxuICAgIGxldCB1bnVzZWFibGU6IG51bWJlcltdID0gW10sXG4gICAgICBuZWVkVXBkYXRlID0gZmFsc2U7XG4gICAgdGhpcy5zdGF0ZS5tb250aHNcbiAgICAgIC5maWx0ZXIobSA9PiB7XG4gICAgICAgIHJldHVybiBtLmZpcnN0RGF0ZSA+PSBzdGFydE1vbnRoRGF0ZSAmJiBtLmZpcnN0RGF0ZSA8PSBlbmRNb250aERhdGU7XG4gICAgICB9KVxuICAgICAgLmZvckVhY2gobSA9PiB7XG4gICAgICAgIG0ud2Vla3MuZm9yRWFjaCh3ID0+XG4gICAgICAgICAgd1xuICAgICAgICAgICAgLmZpbHRlcihkID0+IHtcbiAgICAgICAgICAgICAgaWYgKCFlbmREYXRlVGljaykge1xuICAgICAgICAgICAgICAgIHJldHVybiBkLnRpY2sgJiYgdGhpcy5pbkRhdGUoc3RhcnREYXRlVGljaywgZC50aWNrKTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZC50aWNrICYmIGQudGljayA+PSBzdGFydERhdGVUaWNrICYmIGQudGljayA8PSBlbmREYXRlVGljaztcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5mb3JFYWNoKGQgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IGQuc2VsZWN0ZWQ7XG4gICAgICAgICAgICAgIGlmIChjbGVhcikge1xuICAgICAgICAgICAgICAgIGQuc2VsZWN0ZWQgPSBEYXRlTW9kZWxzLlNlbGVjdFR5cGUuTm9uZTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBpbmZvID0gKGdldERhdGVFeHRyYSAmJiBnZXREYXRlRXh0cmEobmV3IERhdGUoZC50aWNrKSkpIHx8IHt9O1xuICAgICAgICAgICAgICAgIGlmIChkLm91dE9mRGF0ZSB8fCBpbmZvLmRpc2FibGUpIHtcbiAgICAgICAgICAgICAgICAgIHVudXNlYWJsZS5wdXNoKGQudGljayk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmluRGF0ZShzdGFydERhdGVUaWNrLCBkLnRpY2spKSB7XG4gICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ29uZScpIHtcbiAgICAgICAgICAgICAgICAgICAgZC5zZWxlY3RlZCA9IERhdGVNb2RlbHMuU2VsZWN0VHlwZS5TaW5nbGU7XG4gICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFlbmREYXRlVGljaykge1xuICAgICAgICAgICAgICAgICAgICBkLnNlbGVjdGVkID0gRGF0ZU1vZGVscy5TZWxlY3RUeXBlLk9ubHk7XG4gICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0RGF0ZVRpY2sgIT09IGVuZERhdGVUaWNrKSB7XG4gICAgICAgICAgICAgICAgICAgIGQuc2VsZWN0ZWQgPSBEYXRlTW9kZWxzLlNlbGVjdFR5cGUuU3RhcnQ7XG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBkLnNlbGVjdGVkID0gRGF0ZU1vZGVscy5TZWxlY3RUeXBlLkFsbDtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5EYXRlKGVuZERhdGVUaWNrLCBkLnRpY2spKSB7XG4gICAgICAgICAgICAgICAgICBkLnNlbGVjdGVkID0gRGF0ZU1vZGVscy5TZWxlY3RUeXBlLkVuZDtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgZC5zZWxlY3RlZCA9IERhdGVNb2RlbHMuU2VsZWN0VHlwZS5NaWRkbGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIG5lZWRVcGRhdGUgPSBuZWVkVXBkYXRlIHx8IGQuc2VsZWN0ZWQgIT09IG9sZFZhbHVlO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKG5lZWRVcGRhdGUgJiYgbS5jb21wb25lbnRSZWYpIHtcbiAgICAgICAgICBtLmNvbXBvbmVudFJlZi51cGRhdGVXZWVrcygpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICBpZiAodW51c2VhYmxlLmxlbmd0aCA+IDApIHtcbiAgICAgIGlmIChvblNlbGVjdEhhc0Rpc2FibGVEYXRlKSB7XG4gICAgICAgIG9uU2VsZWN0SGFzRGlzYWJsZURhdGUodW51c2VhYmxlLm1hcCh0aWNrID0+IG5ldyBEYXRlKHRpY2spKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLndhcm4oJ1VudXNhYmxlIGRhdGUuIFlvdSBjYW4gaGFuZGxlIGJ5IG9uU2VsZWN0SGFzRGlzYWJsZURhdGUuJywgdW51c2VhYmxlKTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgY29tcHV0ZVZpc2libGUgPSAoY2xpZW50SGVpZ2h0OiBudW1iZXIsIHNjcm9sbFRvcDogbnVtYmVyKSA9PiB7XG4gICAgbGV0IG5lZWRVcGRhdGUgPSBmYWxzZTtcbiAgICBjb25zdCBNQVhfVklFV19QT1JUID0gY2xpZW50SGVpZ2h0ICogMjtcbiAgICBjb25zdCBNSU5fVklFV19QT1JUID0gY2xpZW50SGVpZ2h0O1xuXG4gICAgLy8g5aSn57yT5Yay5Yy65aSW6L+H5ruk6KeE5YiZXG4gICAgY29uc3QgZmlsdGVyRnVuYyA9ICh2bTogRGF0ZU1vZGVscy5Nb250aERhdGEpID0+XG4gICAgICB2bS55ICYmXG4gICAgICB2bS5oZWlnaHQgJiZcbiAgICAgICh2bS55ICsgdm0uaGVpZ2h0ID4gc2Nyb2xsVG9wIC0gTUFYX1ZJRVdfUE9SVCAmJiB2bS55IDwgc2Nyb2xsVG9wICsgY2xpZW50SGVpZ2h0ICsgTUFYX1ZJRVdfUE9SVCk7XG5cbiAgICBpZiAodGhpcy5wcm9wcy5pbmZpbml0ZU9wdCAmJiB0aGlzLnZpc2libGVNb250aC5sZW5ndGggPiAxMikge1xuICAgICAgdGhpcy52aXNpYmxlTW9udGggPSB0aGlzLnZpc2libGVNb250aC5maWx0ZXIoZmlsdGVyRnVuYykuc29ydCgoYSwgYikgPT4gK2EuZmlyc3REYXRlIC0gK2IuZmlyc3REYXRlKTtcbiAgICB9XG5cbiAgICAvLyDlvZPlsI/nvJPlhrLljLrkuI3mu6Hml7bloavlhYVcbiAgICBpZiAodGhpcy52aXNpYmxlTW9udGgubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgbGFzdCA9IHRoaXMudmlzaWJsZU1vbnRoW3RoaXMudmlzaWJsZU1vbnRoLmxlbmd0aCAtIDFdO1xuICAgICAgaWYgKGxhc3QueSAhPT0gdW5kZWZpbmVkICYmIGxhc3QuaGVpZ2h0ICYmIGxhc3QueSArIGxhc3QuaGVpZ2h0IDwgc2Nyb2xsVG9wICsgY2xpZW50SGVpZ2h0ICsgTUlOX1ZJRVdfUE9SVCkge1xuICAgICAgICBjb25zdCBsYXN0SW5kZXggPSB0aGlzLnN0YXRlLm1vbnRocy5pbmRleE9mKGxhc3QpO1xuICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8PSAyOyBpKyspIHtcbiAgICAgICAgICBjb25zdCBpbmRleCA9IGxhc3RJbmRleCArIGk7XG4gICAgICAgICAgaWYgKGluZGV4IDwgdGhpcy5zdGF0ZS5tb250aHMubGVuZ3RoICYmIHRoaXMudmlzaWJsZU1vbnRoLmluZGV4T2YodGhpcy5zdGF0ZS5tb250aHNbaW5kZXhdKSA8IDApIHtcbiAgICAgICAgICAgIHRoaXMudmlzaWJsZU1vbnRoLnB1c2godGhpcy5zdGF0ZS5tb250aHNbaW5kZXhdKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5jYW5Mb2FkTmV4dCgpICYmIHRoaXMuZ2VuTW9udGhEYXRhKHVuZGVmaW5lZCwgMSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIG5lZWRVcGRhdGUgPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBmaXJzdCA9IHRoaXMudmlzaWJsZU1vbnRoWzBdO1xuICAgICAgaWYgKGZpcnN0LnkgIT09IHVuZGVmaW5lZCAmJiBmaXJzdC5oZWlnaHQgJiYgZmlyc3QueSA+IHNjcm9sbFRvcCAtIE1JTl9WSUVXX1BPUlQpIHtcbiAgICAgICAgY29uc3QgZmlyc3RJbmRleCA9IHRoaXMuc3RhdGUubW9udGhzLmluZGV4T2YoZmlyc3QpO1xuICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8PSAyOyBpKyspIHtcbiAgICAgICAgICBjb25zdCBpbmRleCA9IGZpcnN0SW5kZXggLSBpO1xuICAgICAgICAgIGlmIChpbmRleCA+PSAwICYmIHRoaXMudmlzaWJsZU1vbnRoLmluZGV4T2YodGhpcy5zdGF0ZS5tb250aHNbaW5kZXhdKSA8IDApIHtcbiAgICAgICAgICAgIHRoaXMudmlzaWJsZU1vbnRoLnVuc2hpZnQodGhpcy5zdGF0ZS5tb250aHNbaW5kZXhdKTtcbiAgICAgICAgICAgIG5lZWRVcGRhdGUgPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAodGhpcy5zdGF0ZS5tb250aHMubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy52aXNpYmxlTW9udGggPSB0aGlzLnN0YXRlLm1vbnRocy5maWx0ZXIoZmlsdGVyRnVuYyk7XG4gICAgICBuZWVkVXBkYXRlID0gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmVlZFVwZGF0ZTtcbiAgfTtcblxuICBjcmVhdGVPblNjcm9sbCA9ICgpID0+IHtcbiAgICAvLyBsZXQgdGltZXI6IGFueTtcbiAgICBsZXQgY2xpZW50SGVpZ2h0ID0gMCxcbiAgICAgIHNjcm9sbFRvcCA9IDA7XG5cbiAgICByZXR1cm4gKGRhdGE6IHsgZnVsbDogbnVtYmVyOyBjbGllbnQ6IG51bWJlcjsgdG9wOiBudW1iZXIgfSkgPT4ge1xuICAgICAgY29uc3QgeyBjbGllbnQsIHRvcCB9ID0gZGF0YTtcbiAgICAgIGNsaWVudEhlaWdodCA9IGNsaWVudDtcbiAgICAgIHNjcm9sbFRvcCA9IHRvcDtcblxuICAgICAgdGhpcy5jb21wdXRlVmlzaWJsZShjbGllbnRIZWlnaHQsIHNjcm9sbFRvcCk7XG5cbiAgICAgIC8vIOS7peS4iuaWueazleebruWJjeaXoOmXrumimO+8jOWmguaenOWQjue7reacieaAp+iDvemXrumimO+8jOaUueeUqOWmguS4i+aWueazle+8jOS9huS7peS4i+aWueazleS8muWvvOiHtOWIt+aWsOeojeW+ruW7tui/n+eOsOixoVxuXG4gICAgICAvLyBpZiAodGltZXIpIHtcbiAgICAgIC8vICAgcmV0dXJuO1xuICAgICAgLy8gfVxuICAgICAgLy9cbiAgICAgIC8vIHRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAvLyAgIHRpbWVyID0gdW5kZWZpbmVkO1xuICAgICAgLy9cbiAgICAgIC8vICAgaWYgKHRoaXMuY29tcHV0ZVZpc2libGUoY2xpZW50SGVpZ2h0LCBzY3JvbGxUb3ApKSB7XG4gICAgICAvLyAgICAgY29uc29sZS5sb2coJ3VwZGF0ZSBkb20nKTtcbiAgICAgIC8vICAgfVxuICAgICAgLy8gfSwgNTApO1xuICAgIH07XG4gIH07XG5cbiAgYmFzZU9uQ2VsbENsaWNrID0gKGRheTogRGF0ZU1vZGVscy5DZWxsRGF0YSkgPT4ge1xuICAgIGlmICghZGF5LnRpY2spIHJldHVybjtcbiAgICB0aGlzLnByb3BzLm9uQ2VsbENsaWNrICYmIHRoaXMucHJvcHMub25DZWxsQ2xpY2sobmV3IERhdGUoZGF5LnRpY2spKTtcbiAgfTtcblxufVxuIl19